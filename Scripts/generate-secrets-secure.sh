#!/usr/bin/env bash

set -e
set -o pipefail
# NO set -x to avoid exposing secrets in logs

SECRETS_FILE="Convos/Config/Secrets.swift"
APPCLIP_SECRETS_FILE="ConvosAppClip/Config/Secrets.swift"

echo "🔑 Generating Secrets.swift from environment variables"

# CONVOS_API_BASE_URL and XMTP_CUSTOM_HOST are optional (can be empty)

# Create directories if needed
mkdir -p "Convos/Config"
mkdir -p "ConvosAppClip/Config"

# Generate Secrets.swift WITHOUT exposing values in logs
cat >"$SECRETS_FILE" <<EOF
import Foundation

// WARNING:
// This code is generated by ./Scripts/generate-secrets-secure.sh.
// Do not edit this file directly. Your changes will be lost on next run.
// Git does not track this file.

/// Secrets are generated from environment variables by ./Scripts/generate-secrets-secure.sh
enum Secrets {
    static let CONVOS_API_BASE_URL: String = "${CONVOS_API_BASE_URL:-}"
    static let XMTP_CUSTOM_HOST: String = "${XMTP_CUSTOM_HOST:-}"
}
EOF

# Copy the generated file to ConvosAppClip
cp "$SECRETS_FILE" "$APPCLIP_SECRETS_FILE"

echo "✅ Generated Secrets.swift with configuration:"

# Display values
if [[ -z "$CONVOS_API_BASE_URL" ]]; then
    echo "  - CONVOS_API_BASE_URL: (empty - will use default from config.json)"
else
    echo "  - CONVOS_API_BASE_URL: $CONVOS_API_BASE_URL"
fi

if [[ -z "$XMTP_CUSTOM_HOST" ]]; then
    echo "  - XMTP_CUSTOM_HOST: (empty - will use default)"
else
    echo "  - XMTP_CUSTOM_HOST: $XMTP_CUSTOM_HOST"
fi

echo ""
echo "🔐 Secrets.swift generated successfully at:"
echo "   - $SECRETS_FILE"
echo "   - $APPCLIP_SECRETS_FILE"
