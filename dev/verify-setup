#!/bin/bash
set -e

echo "ğŸ” Verifying XMTP test infrastructure setup..."
echo ""

# Color codes
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

errors=0
warnings=0

# Check Docker
echo "Checking Docker..."
if command -v docker &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} Docker is installed"
    if docker info > /dev/null 2>&1; then
        echo -e "${GREEN}âœ“${NC} Docker daemon is running"
    else
        echo -e "${RED}âœ—${NC} Docker daemon is not running"
        errors=$((errors + 1))
    fi
else
    echo -e "${RED}âœ—${NC} Docker is not installed"
    errors=$((errors + 1))
fi
echo ""

# Check docker-compose
echo "Checking docker-compose..."
if command -v docker-compose &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} docker-compose is installed"
else
    echo -e "${YELLOW}âš ${NC} docker-compose not found, will use 'docker compose'"
    warnings=$((warnings + 1))
fi
echo ""

# Check required files
echo "Checking required files..."
required_files=(
    "dev/docker-compose.yml"
    "dev/up"
    "dev/down"
    "dev/compose"
    "dev/test"
    "dev/README.md"
    "ConvosCore/Tests/ConvosCoreTests/TestHelpers.swift"
    "ConvosCore/Tests/ConvosCoreTests/InboxStateMachineTests.swift"
    ".github/workflows/inbox-state-machine-tests.yml"
)

for file in "${required_files[@]}"; do
    if [ -f "$file" ]; then
        echo -e "${GREEN}âœ“${NC} $file"
    else
        echo -e "${RED}âœ—${NC} $file not found"
        errors=$((errors + 1))
    fi
done
echo ""

# Check script permissions
echo "Checking script permissions..."
scripts=("dev/up" "dev/down" "dev/compose" "dev/test")
for script in "${scripts[@]}"; do
    if [ -x "$script" ]; then
        echo -e "${GREEN}âœ“${NC} $script is executable"
    else
        echo -e "${RED}âœ—${NC} $script is not executable"
        errors=$((errors + 1))
    fi
done
echo ""

# Check Swift
echo "Checking Swift..."
if command -v swift &> /dev/null; then
    swift_version=$(swift --version 2>&1 | head -n 1)
    echo -e "${GREEN}âœ“${NC} Swift is installed: $swift_version"
else
    echo -e "${RED}âœ—${NC} Swift is not installed"
    errors=$((errors + 1))
fi
echo ""

# Check netcat
echo "Checking netcat (nc)..."
if command -v nc &> /dev/null; then
    echo -e "${GREEN}âœ“${NC} netcat is available"
else
    echo -e "${YELLOW}âš ${NC} netcat not found (used for port checking)"
    warnings=$((warnings + 1))
fi
echo ""

# Summary
echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
if [ $errors -eq 0 ] && [ $warnings -eq 0 ]; then
    echo -e "${GREEN}âœ“ All checks passed!${NC}"
    echo ""
    echo "You can now run tests with:"
    echo "  ./dev/test"
    echo ""
    echo "Or manually:"
    echo "  ./dev/up                     # Start XMTP node"
    echo "  cd ConvosCore && TEST_SERVER_ENABLED=true swift test --filter InboxStateMachineTests"
    echo "  ./dev/down                   # Stop XMTP node"
    exit 0
elif [ $errors -eq 0 ]; then
    echo -e "${YELLOW}âš  Setup complete with $warnings warning(s)${NC}"
    echo ""
    echo "You can still run tests, but some features may not work optimally."
    exit 0
else
    echo -e "${RED}âœ— Setup incomplete: $errors error(s), $warnings warning(s)${NC}"
    echo ""
    echo "Please fix the errors above before running tests."
    exit 1
fi
