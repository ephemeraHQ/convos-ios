name: InboxStateMachine Tests

on:
  workflow_dispatch:
  pull_request:
    paths:
      - 'ConvosCore/Sources/ConvosCore/Inboxes/**'
      - 'ConvosCore/Tests/ConvosCoreTests/InboxStateMachineTests.swift'
      - 'ConvosCore/Tests/ConvosCoreTests/TestHelpers.swift'
      - 'dev/**'
      - '.github/workflows/inbox-state-machine-tests.yml'
  push:
    branches:
      - main
      - dev
    paths:
      - 'ConvosCore/Sources/ConvosCore/Inboxes/**'
      - 'ConvosCore/Tests/ConvosCoreTests/InboxStateMachineTests.swift'
      - 'ConvosCore/Tests/ConvosCoreTests/TestHelpers.swift'
      - 'dev/**'

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  test:
    name: Run InboxStateMachine Tests
    runs-on: macos-26
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          submodules: recursive

      - name: Select Xcode (use default on macOS 26)
        run: xcodebuild -version

      - name: Show environment
        run: |
          xcodebuild -version
          swift --version
          docker --version
          docker-compose --version

      - name: Start Docker XMTP node
        run: |
          echo "ğŸ³ Starting local XMTP node with Docker..."
          cd dev
          chmod +x up compose
          ./up
          echo "âœ… Docker containers started"

      - name: Wait for XMTP node to be ready
        run: |
          echo "â³ Waiting for XMTP node to be ready..."
          max_attempts=30
          attempt=0

          while [ $attempt -lt $max_attempts ]; do
            if nc -z localhost 5556 2>/dev/null; then
              echo "âœ… XMTP node is ready!"
              sleep 5  # Give it a few more seconds to fully initialize
              exit 0
            fi

            attempt=$((attempt + 1))
            echo "Attempt $attempt/$max_attempts - waiting for XMTP node..."
            sleep 2
          done

          echo "âŒ XMTP node failed to start within the timeout"
          docker-compose -f dev/docker-compose.yml -p "convos-ios" logs
          exit 1

      - name: Cache Swift Package dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/Library/Developer/Xcode/DerivedData
            ~/Library/Caches/org.swift.swiftpm
          key: ${{ runner.os }}-xcode-${{ hashFiles('Convos.xcodeproj/project.pbxproj', 'ConvosCore/Package.resolved') }}
          restore-keys: |
            ${{ runner.os }}-xcode-

      - name: Resolve dependencies
        run: |
          xcodebuild -resolvePackageDependencies \
            -project Convos.xcodeproj \
            -scheme ConvosCore

      - name: Run InboxStateMachine tests
        env:
          TEST_SERVER_ENABLED: "true"
        run: |
          set -o pipefail
          xcodebuild test \
            -project Convos.xcodeproj \
            -scheme ConvosCore \
            -destination 'platform=iOS Simulator,name=iPhone 17,OS=26.0' \
            -only-testing:ConvosCoreTests/InboxStateMachineTests \
            TEST_SERVER_ENABLED=true \
            2>&1 | tee test-output.log

      - name: Stop Docker containers
        if: always()
        run: |
          echo "ğŸ›‘ Stopping Docker containers..."
          cd dev
          ./compose down
          echo "âœ… Docker containers stopped"

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: inbox-state-machine-test-results
          path: |
            test-output.log
          retention-days: 7

      - name: Check test status
        if: failure()
        run: |
          echo "âŒ InboxStateMachine tests failed! Check the uploaded artifacts for details."
          exit 1
